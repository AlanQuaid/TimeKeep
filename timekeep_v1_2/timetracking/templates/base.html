<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{% endblock %}TimeKeep</title>
      {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
    <link href="{% static 'css/test.css' %}" rel="stylesheet">
    <link href="{% static 'css/test2.css' %}" rel="stylesheet">
  </head>
  <body>

{% include 'messages.html' %}


<div id="navbar-app">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
          <a class="navbar-brand" href="{% url 'home' %}"><strong>TimeKeep</strong></a>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="{% url 'home' %}">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'shop' %}">Shop</a>
            </li>
          </ul>
        </div>

          <ul class="nav navbar-nav navbar-right">
           {% if user.is_authenticated %}

                <li class="nav-item"><a class="nav-link active" href="{% url 'account' %}?next={{ request.path }}">{% firstof request.user.get_full_name request.user.username %}{% if active_team %} ({{ active_team.title }}){% endif %}</a></li>
              {% if active_team %}
                <li class="nav-item" v-if="!trackingTime"><a class="btn btn-primary" @click="startTimer()" role="button">
                                        <span class="icon"><i class="fas fa-stopwatch"></i></span>
                                        <span>Start</span>
                                    </a></li>
                 <li class="nav-item" v-else><a class="btn btn-primary" @click="stopTimer()" role="button">
                                        <span class="icon"><i class="fas fa-stopwatch"></i></span>
                                        <span>[[ readableSeconds ]] (stop)</span>
                                    </a></li>
                <li class="nav-item"><a class="nav-link active" href="{% url 'project:projects' %}">Projects</a></li>
              {% endif %}
                <li class="nav-item"><button type="button" class="btn btn-danger px-4 me-md-2" onclick="location.href='{% url 'logout' %}?next={{ request.path }}'">Logout</button></li>
           {% else %}
              <li class="nav-item"><button type="button" class="btn btn-success px-4 me-md-2" onclick="location.href='{% url 'signup' %}'">Sign up</button></li>
              <li class="nav-item"><button type="button" class="btn btn-primary px-4 me-md-2" onclick="location.href='{% url 'login' %}'">Login</button></li>
           {% endif %}
        </ul>
      </div>
        </nav>
        <div class="modal" :class="{'is-active': showTrackingModal}" style="background-color: rgba(0,0,0,0.4)">
                <div class="modal-background"></div>

                <div class="modal-card">
                    <div class="modal-card-head">
                        <p class="modal-card-title">Tracked time</p>
                    </div>

                    <div class="modal-card-body">
                        <p>You have tracked [[ readableSeconds ]]</p>
                    </div>

                    <footer class="modal-card-foot">
                        <a class="btn btn-primary" @click="addToProject()" role="button">Add Time</a>
                        <a class="btn btn-danger" @click="discardTimer()" role="button">Discard</a>
                    </footer>
                </div>
        </div>
    </div>
</div>
<br>
     {% block content %}

     {% endblock %}
            <script src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>
        <script src="https://unpkg.com/vue@next"></script>
        <script>
            var NavbarApp = {
                data() {
                    return {
                        seconds: {{ active_entry_seconds }},
                        trackingTime: false,
                        showTrackingModal: false,
                        timer: null,
                        entryID: 0,
                        startTime: '{{ start_time }}'
                    }
                },
                delimiters: ['[[', ']]'],
                methods: {
                    startTimer() {
                        fetch('/timetracking/timer/start_timer/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        })
                        .then((response) => {
                            return response.json()
                        })
                        .then((result) => {
                            this.startTime = new Date()
                            this.trackingTime = true

                            this.timer = setInterval(() => {
                                this.seconds = (new Date() - this.startTime) / 1000
                            }, 1000)
                        })
                    },
                    stopTimer() {
                        fetch('/timetracking/timer/stop_timer/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        })
                        .then((response) => {
                            return response.json()
                        })
                        .then((result) => {
                            this.entryID = result.entryID
                            this.showTrackingModal = true
                            this.trackingTime = false

                            window.clearTimeout(this.timer)
                        })
                    },
                    discardTimer() {
                        fetch('/timetracking/timer/discard_timer/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            }
                        })
                        .then((response) => {
                            this.seconds = 0
                            this.showTrackingModal = false
                        })
                    },
                    addLater() {
                        this.seconds = 0
                        this.showTrackingModal = false
                    },
                    addToProject() {
                        console.log('addToProject')
                        window.location.href = '/projects/add_entry/' + this.entryID + '/'
                    }
                },
                mounted() {
                    if (this.seconds !== 0) {
                        this.trackingTime = true
                        this.timer = setInterval(() => {
                            this.seconds = (new Date() - new Date(this.startTime)) / 1000
                        }, 1000)
                    }
                },
                computed: {
                    readableSeconds() {
                        const d = Number(this.seconds);
                        const h = Math.floor(d / 3600);
                        const m = Math.floor(d % 3600 / 60);
                        const s = Math.floor(d % 3600 % 60);

                        const hDisplay = h > 0 ? h + (h == 1 ? "h, " : "h, ") : "";
                        const mDisplay = m > 0 ? m + (m == 1 ? "m, " : "m, ") : "";
                        const sDisplay = s >= 0 ? s + (s == 1 ? "s" : "s") : "";

                        return hDisplay + mDisplay + sDisplay;
                    }
                }
            }

            Vue.createApp(NavbarApp).mount('#navbar-app')


        </script>
<script>
    var message_ele = document.getElementById("msg");
    setTimeout(function(){
    message_ele.style.display = "none";
    }, 2000);
</script>
        {% block scripts %}
        {% endblock %}
  </body>
</html>

